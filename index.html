<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Processar Produtos</title>
<style>
    table {
        border-collapse: collapse;
        width: 100%;
    }

    th, td {
        border: 1px solid #dddddd;
        text-align: left;
        padding: 8px;
    }

    th {
        background-color: #f2f2f2;
    }
</style>
</head>
<body>

<h1>Processar Produtos</h1>

<label for="processar">Clique para Processar:</label>
<button id="processar">Processar</button>

<table id="resultado">
    <thead>
        <tr>
            <th>Família</th>
            <th>Subfamília</th>
            <th>Produto</th>
            <th>Preço de Venda</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
document.getElementById("processar").addEventListener("click", function() {
    // Fazendo a leitura dos arquivos CSV
    fetch('tabpadrao.csv')
        .then(response => response.text())
        .then(tabpadraoData => {
            fetch('bddic.csv')
                .then(response => response.text())
                .then(bddicData => {
                    processarResultado(tabpadraoData, bddicData);
                });
        });
});

function processarResultado(tabpadraoData, bddicData) {
    const tableBody = document.querySelector('#resultado tbody');
    tableBody.innerHTML = ''; // Limpar tabela anterior, se houver

    const tabpadraoLinhas = tabpadraoData.split('\n').slice(1);
    const bddicLinhas = bddicData.split('\n').slice(1);

    const familiasSubfamilias = {};

    tabpadraoLinhas.forEach(tabpadraoLinha => {
        const tabpadraoCols = tabpadraoLinha.split(';');
        const nomeProdutoTabpadrao = tabpadraoCols[2];
        const precoVenda = tabpadraoCols[3];

        const produtoBddic = bddicLinhas.find(bddicLinha => {
            const bddicCols = bddicLinha.split(';');
            const nomeProdutoBddic = bddicCols[4];
            return nomeProdutoBddic === nomeProdutoTabpadrao;
        });

        if (produtoBddic) {
            const bddicCols = produtoBddic.split(';');
            const familiaSubfamilia = `${bddicCols[0]} - ${bddicCols[1]}`;
            const familia = bddicCols[0];
            const subfamilia = bddicCols[1];

            let existingRow = tableBody.querySelector(`tr[data-subfamilia="${familia}-${subfamilia}"]`);
            if (!existingRow) {
                existingRow = document.createElement('tr');
                existingRow.setAttribute('data-subfamilia', `${familia}-${subfamilia}`);
                existingRow.innerHTML = `<td>${familiaSubfamilia}</td><td>${nomeProdutoTabpadrao}</td><td>${precoVenda}</td>`;
                tableBody.appendChild(existingRow);

                familiasSubfamilias[`${familia}-${subfamilia}`] = [{ precoVenda, nomeProdutoTabpadrao }];
            } else {
                const existingProducts = familiasSubfamilias[`${familia}-${subfamilia}`];
                const hasPrice = existingProducts.some(product => product.precoVenda === precoVenda);
                if (!hasPrice) {
                    existingProducts.push({ precoVenda, nomeProdutoTabpadrao });
                    const productNames = existingProducts.map(product => product.nomeProdutoTabpadrao).join('<br>');
                    const priceCell = existingRow.querySelector('td:nth-child(3)');
                    priceCell.innerHTML += `<br>${precoVenda}`;
                    const productCell = existingRow.querySelector('td:nth-child(2)');
                    productCell.innerHTML = productNames;
                }
            }
        }
    });
}



</script>

</body>
</html>
